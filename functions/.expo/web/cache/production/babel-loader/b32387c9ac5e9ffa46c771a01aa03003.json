{"ast":null,"code":"var capability=require(\"./capability\");var inherits=require('inherits');var stream=require('readable-stream');var rStates=exports.readyStates={UNSENT:0,OPENED:1,HEADERS_RECEIVED:2,LOADING:3,DONE:4};var IncomingMessage=exports.IncomingMessage=function(xhr,response,mode,fetchTimer){var self=this;stream.Readable.call(self);self._mode=mode;self.headers={};self.rawHeaders=[];self.trailers={};self.rawTrailers=[];self.on('end',function(){process.nextTick(function(){self.emit('close');});});if(mode==='fetch'){self._fetchResponse=response;self.url=response.url;self.statusCode=response.status;self.statusMessage=response.statusText;response.headers.forEach(function(header,key){self.headers[key.toLowerCase()]=header;self.rawHeaders.push(key,header);});if(capability.writableStream){var writable=new WritableStream({write:function write(chunk){return new Promise(function(resolve,reject){if(self._destroyed){reject();}else if(self.push(new Buffer(chunk))){resolve();}else{self._resumeFetch=resolve;}});},close:function close(){global.clearTimeout(fetchTimer);if(!self._destroyed)self.push(null);},abort:function abort(err){if(!self._destroyed)self.emit('error',err);}});try{response.body.pipeTo(writable).catch(function(err){global.clearTimeout(fetchTimer);if(!self._destroyed)self.emit('error',err);});return;}catch(e){}}var reader=response.body.getReader();function read(){reader.read().then(function(result){if(self._destroyed)return;if(result.done){global.clearTimeout(fetchTimer);self.push(null);return;}self.push(new Buffer(result.value));read();}).catch(function(err){global.clearTimeout(fetchTimer);if(!self._destroyed)self.emit('error',err);});}read();}else{self._xhr=xhr;self._pos=0;self.url=xhr.responseURL;self.statusCode=xhr.status;self.statusMessage=xhr.statusText;var headers=xhr.getAllResponseHeaders().split(/\\r?\\n/);headers.forEach(function(header){var matches=header.match(/^([^:]+):\\s*(.*)/);if(matches){var key=matches[1].toLowerCase();if(key==='set-cookie'){if(self.headers[key]===undefined){self.headers[key]=[];}self.headers[key].push(matches[2]);}else if(self.headers[key]!==undefined){self.headers[key]+=', '+matches[2];}else{self.headers[key]=matches[2];}self.rawHeaders.push(matches[1],matches[2]);}});self._charset='x-user-defined';if(!capability.overrideMimeType){var mimeType=self.rawHeaders['mime-type'];if(mimeType){var charsetMatch=mimeType.match(/;\\s*charset=([^;])(;|$)/);if(charsetMatch){self._charset=charsetMatch[1].toLowerCase();}}if(!self._charset)self._charset='utf-8';}}};inherits(IncomingMessage,stream.Readable);IncomingMessage.prototype._read=function(){var self=this;var resolve=self._resumeFetch;if(resolve){self._resumeFetch=null;resolve();}};IncomingMessage.prototype._onXHRProgress=function(){var self=this;var xhr=self._xhr;var response=null;switch(self._mode){case'text:vbarray':if(xhr.readyState!==rStates.DONE)break;try{response=new global.VBArray(xhr.responseBody).toArray();}catch(e){}if(response!==null){self.push(new Buffer(response));break;}case'text':try{response=xhr.responseText;}catch(e){self._mode='text:vbarray';break;}if(response.length>self._pos){var newData=response.substr(self._pos);if(self._charset==='x-user-defined'){var buffer=new Buffer(newData.length);for(var i=0;i<newData.length;i++){buffer[i]=newData.charCodeAt(i)&0xff;}self.push(buffer);}else{self.push(newData,self._charset);}self._pos=response.length;}break;case'arraybuffer':if(xhr.readyState!==rStates.DONE||!xhr.response)break;response=xhr.response;self.push(new Buffer(new Uint8Array(response)));break;case'moz-chunked-arraybuffer':response=xhr.response;if(xhr.readyState!==rStates.LOADING||!response)break;self.push(new Buffer(new Uint8Array(response)));break;case'ms-stream':response=xhr.response;if(xhr.readyState!==rStates.LOADING)break;var reader=new global.MSStreamReader();reader.onprogress=function(){if(reader.result.byteLength>self._pos){self.push(new Buffer(new Uint8Array(reader.result.slice(self._pos))));self._pos=reader.result.byteLength;}};reader.onload=function(){self.push(null);};reader.readAsArrayBuffer(response);break;}if(self._xhr.readyState===rStates.DONE&&self._mode!=='ms-stream'){self.push(null);}};","map":{"version":3,"sources":["/usr/local/lib/node_modules/expo-cli/node_modules/stream-http/lib/response.js"],"names":["capability","require","inherits","stream","rStates","exports","readyStates","UNSENT","OPENED","HEADERS_RECEIVED","LOADING","DONE","IncomingMessage","xhr","response","mode","fetchTimer","self","Readable","call","_mode","headers","rawHeaders","trailers","rawTrailers","on","process","nextTick","emit","_fetchResponse","url","statusCode","status","statusMessage","statusText","forEach","header","key","toLowerCase","push","writableStream","writable","WritableStream","write","chunk","Promise","resolve","reject","_destroyed","Buffer","_resumeFetch","close","global","clearTimeout","abort","err","body","pipeTo","catch","e","reader","getReader","read","then","result","done","value","_xhr","_pos","responseURL","getAllResponseHeaders","split","matches","match","undefined","_charset","overrideMimeType","mimeType","charsetMatch","prototype","_read","_onXHRProgress","readyState","VBArray","responseBody","toArray","responseText","length","newData","substr","buffer","i","charCodeAt","Uint8Array","MSStreamReader","onprogress","byteLength","slice","onload","readAsArrayBuffer"],"mappings":"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","sourcesContent":["var capability = require('./capability')\nvar inherits = require('inherits')\nvar stream = require('readable-stream')\n\nvar rStates = exports.readyStates = {\n\tUNSENT: 0,\n\tOPENED: 1,\n\tHEADERS_RECEIVED: 2,\n\tLOADING: 3,\n\tDONE: 4\n}\n\nvar IncomingMessage = exports.IncomingMessage = function (xhr, response, mode, fetchTimer) {\n\tvar self = this\n\tstream.Readable.call(self)\n\n\tself._mode = mode\n\tself.headers = {}\n\tself.rawHeaders = []\n\tself.trailers = {}\n\tself.rawTrailers = []\n\n\t// Fake the 'close' event, but only once 'end' fires\n\tself.on('end', function () {\n\t\t// The nextTick is necessary to prevent the 'request' module from causing an infinite loop\n\t\tprocess.nextTick(function () {\n\t\t\tself.emit('close')\n\t\t})\n\t})\n\n\tif (mode === 'fetch') {\n\t\tself._fetchResponse = response\n\n\t\tself.url = response.url\n\t\tself.statusCode = response.status\n\t\tself.statusMessage = response.statusText\n\t\t\n\t\tresponse.headers.forEach(function (header, key){\n\t\t\tself.headers[key.toLowerCase()] = header\n\t\t\tself.rawHeaders.push(key, header)\n\t\t})\n\n\t\tif (capability.writableStream) {\n\t\t\tvar writable = new WritableStream({\n\t\t\t\twrite: function (chunk) {\n\t\t\t\t\treturn new Promise(function (resolve, reject) {\n\t\t\t\t\t\tif (self._destroyed) {\n\t\t\t\t\t\t\treject()\n\t\t\t\t\t\t} else if(self.push(new Buffer(chunk))) {\n\t\t\t\t\t\t\tresolve()\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tself._resumeFetch = resolve\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t},\n\t\t\t\tclose: function () {\n\t\t\t\t\tglobal.clearTimeout(fetchTimer)\n\t\t\t\t\tif (!self._destroyed)\n\t\t\t\t\t\tself.push(null)\n\t\t\t\t},\n\t\t\t\tabort: function (err) {\n\t\t\t\t\tif (!self._destroyed)\n\t\t\t\t\t\tself.emit('error', err)\n\t\t\t\t}\n\t\t\t})\n\n\t\t\ttry {\n\t\t\t\tresponse.body.pipeTo(writable).catch(function (err) {\n\t\t\t\t\tglobal.clearTimeout(fetchTimer)\n\t\t\t\t\tif (!self._destroyed)\n\t\t\t\t\t\tself.emit('error', err)\n\t\t\t\t})\n\t\t\t\treturn\n\t\t\t} catch (e) {} // pipeTo method isn't defined. Can't find a better way to feature test this\n\t\t}\n\t\t// fallback for when writableStream or pipeTo aren't available\n\t\tvar reader = response.body.getReader()\n\t\tfunction read () {\n\t\t\treader.read().then(function (result) {\n\t\t\t\tif (self._destroyed)\n\t\t\t\t\treturn\n\t\t\t\tif (result.done) {\n\t\t\t\t\tglobal.clearTimeout(fetchTimer)\n\t\t\t\t\tself.push(null)\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tself.push(new Buffer(result.value))\n\t\t\t\tread()\n\t\t\t}).catch(function (err) {\n\t\t\t\tglobal.clearTimeout(fetchTimer)\n\t\t\t\tif (!self._destroyed)\n\t\t\t\t\tself.emit('error', err)\n\t\t\t})\n\t\t}\n\t\tread()\n\t} else {\n\t\tself._xhr = xhr\n\t\tself._pos = 0\n\n\t\tself.url = xhr.responseURL\n\t\tself.statusCode = xhr.status\n\t\tself.statusMessage = xhr.statusText\n\t\tvar headers = xhr.getAllResponseHeaders().split(/\\r?\\n/)\n\t\theaders.forEach(function (header) {\n\t\t\tvar matches = header.match(/^([^:]+):\\s*(.*)/)\n\t\t\tif (matches) {\n\t\t\t\tvar key = matches[1].toLowerCase()\n\t\t\t\tif (key === 'set-cookie') {\n\t\t\t\t\tif (self.headers[key] === undefined) {\n\t\t\t\t\t\tself.headers[key] = []\n\t\t\t\t\t}\n\t\t\t\t\tself.headers[key].push(matches[2])\n\t\t\t\t} else if (self.headers[key] !== undefined) {\n\t\t\t\t\tself.headers[key] += ', ' + matches[2]\n\t\t\t\t} else {\n\t\t\t\t\tself.headers[key] = matches[2]\n\t\t\t\t}\n\t\t\t\tself.rawHeaders.push(matches[1], matches[2])\n\t\t\t}\n\t\t})\n\n\t\tself._charset = 'x-user-defined'\n\t\tif (!capability.overrideMimeType) {\n\t\t\tvar mimeType = self.rawHeaders['mime-type']\n\t\t\tif (mimeType) {\n\t\t\t\tvar charsetMatch = mimeType.match(/;\\s*charset=([^;])(;|$)/)\n\t\t\t\tif (charsetMatch) {\n\t\t\t\t\tself._charset = charsetMatch[1].toLowerCase()\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!self._charset)\n\t\t\t\tself._charset = 'utf-8' // best guess\n\t\t}\n\t}\n}\n\ninherits(IncomingMessage, stream.Readable)\n\nIncomingMessage.prototype._read = function () {\n\tvar self = this\n\n\tvar resolve = self._resumeFetch\n\tif (resolve) {\n\t\tself._resumeFetch = null\n\t\tresolve()\n\t}\n}\n\nIncomingMessage.prototype._onXHRProgress = function () {\n\tvar self = this\n\n\tvar xhr = self._xhr\n\n\tvar response = null\n\tswitch (self._mode) {\n\t\tcase 'text:vbarray': // For IE9\n\t\t\tif (xhr.readyState !== rStates.DONE)\n\t\t\t\tbreak\n\t\t\ttry {\n\t\t\t\t// This fails in IE8\n\t\t\t\tresponse = new global.VBArray(xhr.responseBody).toArray()\n\t\t\t} catch (e) {}\n\t\t\tif (response !== null) {\n\t\t\t\tself.push(new Buffer(response))\n\t\t\t\tbreak\n\t\t\t}\n\t\t\t// Falls through in IE8\t\n\t\tcase 'text':\n\t\t\ttry { // This will fail when readyState = 3 in IE9. Switch mode and wait for readyState = 4\n\t\t\t\tresponse = xhr.responseText\n\t\t\t} catch (e) {\n\t\t\t\tself._mode = 'text:vbarray'\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tif (response.length > self._pos) {\n\t\t\t\tvar newData = response.substr(self._pos)\n\t\t\t\tif (self._charset === 'x-user-defined') {\n\t\t\t\t\tvar buffer = new Buffer(newData.length)\n\t\t\t\t\tfor (var i = 0; i < newData.length; i++)\n\t\t\t\t\t\tbuffer[i] = newData.charCodeAt(i) & 0xff\n\n\t\t\t\t\tself.push(buffer)\n\t\t\t\t} else {\n\t\t\t\t\tself.push(newData, self._charset)\n\t\t\t\t}\n\t\t\t\tself._pos = response.length\n\t\t\t}\n\t\t\tbreak\n\t\tcase 'arraybuffer':\n\t\t\tif (xhr.readyState !== rStates.DONE || !xhr.response)\n\t\t\t\tbreak\n\t\t\tresponse = xhr.response\n\t\t\tself.push(new Buffer(new Uint8Array(response)))\n\t\t\tbreak\n\t\tcase 'moz-chunked-arraybuffer': // take whole\n\t\t\tresponse = xhr.response\n\t\t\tif (xhr.readyState !== rStates.LOADING || !response)\n\t\t\t\tbreak\n\t\t\tself.push(new Buffer(new Uint8Array(response)))\n\t\t\tbreak\n\t\tcase 'ms-stream':\n\t\t\tresponse = xhr.response\n\t\t\tif (xhr.readyState !== rStates.LOADING)\n\t\t\t\tbreak\n\t\t\tvar reader = new global.MSStreamReader()\n\t\t\treader.onprogress = function () {\n\t\t\t\tif (reader.result.byteLength > self._pos) {\n\t\t\t\t\tself.push(new Buffer(new Uint8Array(reader.result.slice(self._pos))))\n\t\t\t\t\tself._pos = reader.result.byteLength\n\t\t\t\t}\n\t\t\t}\n\t\t\treader.onload = function () {\n\t\t\t\tself.push(null)\n\t\t\t}\n\t\t\t// reader.onerror = ??? // TODO: this\n\t\t\treader.readAsArrayBuffer(response)\n\t\t\tbreak\n\t}\n\n\t// The ms-stream case handles end separately in reader.onload()\n\tif (self._xhr.readyState === rStates.DONE && self._mode !== 'ms-stream') {\n\t\tself.push(null)\n\t}\n}\n"]},"metadata":{},"sourceType":"script"}