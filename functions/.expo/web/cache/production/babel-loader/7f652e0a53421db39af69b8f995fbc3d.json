{"ast":null,"code":"var capability=require(\"./capability\");var inherits=require('inherits');var response=require(\"./response\");var stream=require('readable-stream');var toArrayBuffer=require('to-arraybuffer');var IncomingMessage=response.IncomingMessage;var rStates=response.readyStates;function decideMode(preferBinary,useFetch){if(capability.fetch&&useFetch){return'fetch';}else if(capability.mozchunkedarraybuffer){return'moz-chunked-arraybuffer';}else if(capability.msstream){return'ms-stream';}else if(capability.arraybuffer&&preferBinary){return'arraybuffer';}else if(capability.vbArray&&preferBinary){return'text:vbarray';}else{return'text';}}var ClientRequest=module.exports=function(opts){var self=this;stream.Writable.call(self);self._opts=opts;self._body=[];self._headers={};if(opts.auth)self.setHeader('Authorization','Basic '+new Buffer(opts.auth).toString('base64'));Object.keys(opts.headers).forEach(function(name){self.setHeader(name,opts.headers[name]);});var preferBinary;var useFetch=true;if(opts.mode==='disable-fetch'||'requestTimeout'in opts&&!capability.abortController){useFetch=false;preferBinary=true;}else if(opts.mode==='prefer-streaming'){preferBinary=false;}else if(opts.mode==='allow-wrong-content-type'){preferBinary=!capability.overrideMimeType;}else if(!opts.mode||opts.mode==='default'||opts.mode==='prefer-fast'){preferBinary=true;}else{throw new Error('Invalid value for opts.mode');}self._mode=decideMode(preferBinary,useFetch);self._fetchTimer=null;self.on('finish',function(){self._onFinish();});};inherits(ClientRequest,stream.Writable);ClientRequest.prototype.setHeader=function(name,value){var self=this;var lowerName=name.toLowerCase();if(unsafeHeaders.indexOf(lowerName)!==-1)return;self._headers[lowerName]={name:name,value:value};};ClientRequest.prototype.getHeader=function(name){var header=this._headers[name.toLowerCase()];if(header)return header.value;return null;};ClientRequest.prototype.removeHeader=function(name){var self=this;delete self._headers[name.toLowerCase()];};ClientRequest.prototype._onFinish=function(){var self=this;if(self._destroyed)return;var opts=self._opts;var headersObj=self._headers;var body=null;if(opts.method!=='GET'&&opts.method!=='HEAD'){if(capability.arraybuffer){body=toArrayBuffer(Buffer.concat(self._body));}else if(capability.blobConstructor){body=new global.Blob(self._body.map(function(buffer){return toArrayBuffer(buffer);}),{type:(headersObj['content-type']||{}).value||''});}else{body=Buffer.concat(self._body).toString();}}var headersList=[];Object.keys(headersObj).forEach(function(keyName){var name=headersObj[keyName].name;var value=headersObj[keyName].value;if(Array.isArray(value)){value.forEach(function(v){headersList.push([name,v]);});}else{headersList.push([name,value]);}});if(self._mode==='fetch'){var signal=null;var fetchTimer=null;if(capability.abortController){var controller=new AbortController();signal=controller.signal;self._fetchAbortController=controller;if('requestTimeout'in opts&&opts.requestTimeout!==0){self._fetchTimer=global.setTimeout(function(){self.emit('requestTimeout');if(self._fetchAbortController)self._fetchAbortController.abort();},opts.requestTimeout);}}global.fetch(self._opts.url,{method:self._opts.method,headers:headersList,body:body||undefined,mode:'cors',credentials:opts.withCredentials?'include':'same-origin',signal:signal}).then(function(response){self._fetchResponse=response;self._connect();},function(reason){global.clearTimeout(self._fetchTimer);if(!self._destroyed)self.emit('error',reason);});}else{var xhr=self._xhr=new global.XMLHttpRequest();try{xhr.open(self._opts.method,self._opts.url,true);}catch(err){process.nextTick(function(){self.emit('error',err);});return;}if('responseType'in xhr)xhr.responseType=self._mode.split(':')[0];if('withCredentials'in xhr)xhr.withCredentials=!!opts.withCredentials;if(self._mode==='text'&&'overrideMimeType'in xhr)xhr.overrideMimeType('text/plain; charset=x-user-defined');if('requestTimeout'in opts){xhr.timeout=opts.requestTimeout;xhr.ontimeout=function(){self.emit('requestTimeout');};}headersList.forEach(function(header){xhr.setRequestHeader(header[0],header[1]);});self._response=null;xhr.onreadystatechange=function(){switch(xhr.readyState){case rStates.LOADING:case rStates.DONE:self._onXHRProgress();break;}};if(self._mode==='moz-chunked-arraybuffer'){xhr.onprogress=function(){self._onXHRProgress();};}xhr.onerror=function(){if(self._destroyed)return;self.emit('error',new Error('XHR error'));};try{xhr.send(body);}catch(err){process.nextTick(function(){self.emit('error',err);});return;}}};function statusValid(xhr){try{var status=xhr.status;return status!==null&&status!==0;}catch(e){return false;}}ClientRequest.prototype._onXHRProgress=function(){var self=this;if(!statusValid(self._xhr)||self._destroyed)return;if(!self._response)self._connect();self._response._onXHRProgress();};ClientRequest.prototype._connect=function(){var self=this;if(self._destroyed)return;self._response=new IncomingMessage(self._xhr,self._fetchResponse,self._mode,self._fetchTimer);self._response.on('error',function(err){self.emit('error',err);});self.emit('response',self._response);};ClientRequest.prototype._write=function(chunk,encoding,cb){var self=this;self._body.push(chunk);cb();};ClientRequest.prototype.abort=ClientRequest.prototype.destroy=function(){var self=this;self._destroyed=true;global.clearTimeout(self._fetchTimer);if(self._response)self._response._destroyed=true;if(self._xhr)self._xhr.abort();else if(self._fetchAbortController)self._fetchAbortController.abort();};ClientRequest.prototype.end=function(data,encoding,cb){var self=this;if(typeof data==='function'){cb=data;data=undefined;}stream.Writable.prototype.end.call(self,data,encoding,cb);};ClientRequest.prototype.flushHeaders=function(){};ClientRequest.prototype.setTimeout=function(){};ClientRequest.prototype.setNoDelay=function(){};ClientRequest.prototype.setSocketKeepAlive=function(){};var unsafeHeaders=['accept-charset','accept-encoding','access-control-request-headers','access-control-request-method','connection','content-length','cookie','cookie2','date','dnt','expect','host','keep-alive','origin','referer','te','trailer','transfer-encoding','upgrade','via'];","map":{"version":3,"sources":["/usr/local/lib/node_modules/expo-cli/node_modules/stream-http/lib/request.js"],"names":["capability","require","inherits","response","stream","toArrayBuffer","IncomingMessage","rStates","readyStates","decideMode","preferBinary","useFetch","fetch","mozchunkedarraybuffer","msstream","arraybuffer","vbArray","ClientRequest","module","exports","opts","self","Writable","call","_opts","_body","_headers","auth","setHeader","Buffer","toString","Object","keys","headers","forEach","name","mode","abortController","overrideMimeType","Error","_mode","_fetchTimer","on","_onFinish","prototype","value","lowerName","toLowerCase","unsafeHeaders","indexOf","getHeader","header","removeHeader","_destroyed","headersObj","body","method","concat","blobConstructor","global","Blob","map","buffer","type","headersList","keyName","Array","isArray","v","push","signal","fetchTimer","controller","AbortController","_fetchAbortController","requestTimeout","setTimeout","emit","abort","url","undefined","credentials","withCredentials","then","_fetchResponse","_connect","reason","clearTimeout","xhr","_xhr","XMLHttpRequest","open","err","process","nextTick","responseType","split","timeout","ontimeout","setRequestHeader","_response","onreadystatechange","readyState","LOADING","DONE","_onXHRProgress","onprogress","onerror","send","statusValid","status","e","_write","chunk","encoding","cb","destroy","end","data","flushHeaders","setNoDelay","setSocketKeepAlive"],"mappings":"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","sourcesContent":["var capability = require('./capability')\nvar inherits = require('inherits')\nvar response = require('./response')\nvar stream = require('readable-stream')\nvar toArrayBuffer = require('to-arraybuffer')\n\nvar IncomingMessage = response.IncomingMessage\nvar rStates = response.readyStates\n\nfunction decideMode (preferBinary, useFetch) {\n\tif (capability.fetch && useFetch) {\n\t\treturn 'fetch'\n\t} else if (capability.mozchunkedarraybuffer) {\n\t\treturn 'moz-chunked-arraybuffer'\n\t} else if (capability.msstream) {\n\t\treturn 'ms-stream'\n\t} else if (capability.arraybuffer && preferBinary) {\n\t\treturn 'arraybuffer'\n\t} else if (capability.vbArray && preferBinary) {\n\t\treturn 'text:vbarray'\n\t} else {\n\t\treturn 'text'\n\t}\n}\n\nvar ClientRequest = module.exports = function (opts) {\n\tvar self = this\n\tstream.Writable.call(self)\n\n\tself._opts = opts\n\tself._body = []\n\tself._headers = {}\n\tif (opts.auth)\n\t\tself.setHeader('Authorization', 'Basic ' + new Buffer(opts.auth).toString('base64'))\n\tObject.keys(opts.headers).forEach(function (name) {\n\t\tself.setHeader(name, opts.headers[name])\n\t})\n\n\tvar preferBinary\n\tvar useFetch = true\n\tif (opts.mode === 'disable-fetch' || ('requestTimeout' in opts && !capability.abortController)) {\n\t\t// If the use of XHR should be preferred. Not typically needed.\n\t\tuseFetch = false\n\t\tpreferBinary = true\n\t} else if (opts.mode === 'prefer-streaming') {\n\t\t// If streaming is a high priority but binary compatibility and\n\t\t// the accuracy of the 'content-type' header aren't\n\t\tpreferBinary = false\n\t} else if (opts.mode === 'allow-wrong-content-type') {\n\t\t// If streaming is more important than preserving the 'content-type' header\n\t\tpreferBinary = !capability.overrideMimeType\n\t} else if (!opts.mode || opts.mode === 'default' || opts.mode === 'prefer-fast') {\n\t\t// Use binary if text streaming may corrupt data or the content-type header, or for speed\n\t\tpreferBinary = true\n\t} else {\n\t\tthrow new Error('Invalid value for opts.mode')\n\t}\n\tself._mode = decideMode(preferBinary, useFetch)\n\tself._fetchTimer = null\n\n\tself.on('finish', function () {\n\t\tself._onFinish()\n\t})\n}\n\ninherits(ClientRequest, stream.Writable)\n\nClientRequest.prototype.setHeader = function (name, value) {\n\tvar self = this\n\tvar lowerName = name.toLowerCase()\n\t// This check is not necessary, but it prevents warnings from browsers about setting unsafe\n\t// headers. To be honest I'm not entirely sure hiding these warnings is a good thing, but\n\t// http-browserify did it, so I will too.\n\tif (unsafeHeaders.indexOf(lowerName) !== -1)\n\t\treturn\n\n\tself._headers[lowerName] = {\n\t\tname: name,\n\t\tvalue: value\n\t}\n}\n\nClientRequest.prototype.getHeader = function (name) {\n\tvar header = this._headers[name.toLowerCase()]\n\tif (header)\n\t\treturn header.value\n\treturn null\n}\n\nClientRequest.prototype.removeHeader = function (name) {\n\tvar self = this\n\tdelete self._headers[name.toLowerCase()]\n}\n\nClientRequest.prototype._onFinish = function () {\n\tvar self = this\n\n\tif (self._destroyed)\n\t\treturn\n\tvar opts = self._opts\n\n\tvar headersObj = self._headers\n\tvar body = null\n\tif (opts.method !== 'GET' && opts.method !== 'HEAD') {\n\t\tif (capability.arraybuffer) {\n\t\t\tbody = toArrayBuffer(Buffer.concat(self._body))\n\t\t} else if (capability.blobConstructor) {\n\t\t\tbody = new global.Blob(self._body.map(function (buffer) {\n\t\t\t\treturn toArrayBuffer(buffer)\n\t\t\t}), {\n\t\t\t\ttype: (headersObj['content-type'] || {}).value || ''\n\t\t\t})\n\t\t} else {\n\t\t\t// get utf8 string\n\t\t\tbody = Buffer.concat(self._body).toString()\n\t\t}\n\t}\n\n\t// create flattened list of headers\n\tvar headersList = []\n\tObject.keys(headersObj).forEach(function (keyName) {\n\t\tvar name = headersObj[keyName].name\n\t\tvar value = headersObj[keyName].value\n\t\tif (Array.isArray(value)) {\n\t\t\tvalue.forEach(function (v) {\n\t\t\t\theadersList.push([name, v])\n\t\t\t})\n\t\t} else {\n\t\t\theadersList.push([name, value])\n\t\t}\n\t})\n\n\tif (self._mode === 'fetch') {\n\t\tvar signal = null\n\t\tvar fetchTimer = null\n\t\tif (capability.abortController) {\n\t\t\tvar controller = new AbortController()\n\t\t\tsignal = controller.signal\n\t\t\tself._fetchAbortController = controller\n\n\t\t\tif ('requestTimeout' in opts && opts.requestTimeout !== 0) {\n\t\t\t\tself._fetchTimer = global.setTimeout(function () {\n\t\t\t\t\tself.emit('requestTimeout')\n\t\t\t\t\tif (self._fetchAbortController)\n\t\t\t\t\t\tself._fetchAbortController.abort()\n\t\t\t\t}, opts.requestTimeout)\n\t\t\t}\n\t\t}\n\n\t\tglobal.fetch(self._opts.url, {\n\t\t\tmethod: self._opts.method,\n\t\t\theaders: headersList,\n\t\t\tbody: body || undefined,\n\t\t\tmode: 'cors',\n\t\t\tcredentials: opts.withCredentials ? 'include' : 'same-origin',\n\t\t\tsignal: signal\n\t\t}).then(function (response) {\n\t\t\tself._fetchResponse = response\n\t\t\tself._connect()\n\t\t}, function (reason) {\n\t\t\tglobal.clearTimeout(self._fetchTimer)\n\t\t\tif (!self._destroyed)\n\t\t\t\tself.emit('error', reason)\n\t\t})\n\t} else {\n\t\tvar xhr = self._xhr = new global.XMLHttpRequest()\n\t\ttry {\n\t\t\txhr.open(self._opts.method, self._opts.url, true)\n\t\t} catch (err) {\n\t\t\tprocess.nextTick(function () {\n\t\t\t\tself.emit('error', err)\n\t\t\t})\n\t\t\treturn\n\t\t}\n\n\t\t// Can't set responseType on really old browsers\n\t\tif ('responseType' in xhr)\n\t\t\txhr.responseType = self._mode.split(':')[0]\n\n\t\tif ('withCredentials' in xhr)\n\t\t\txhr.withCredentials = !!opts.withCredentials\n\n\t\tif (self._mode === 'text' && 'overrideMimeType' in xhr)\n\t\t\txhr.overrideMimeType('text/plain; charset=x-user-defined')\n\n\t\tif ('requestTimeout' in opts) {\n\t\t\txhr.timeout = opts.requestTimeout\n\t\t\txhr.ontimeout = function () {\n\t\t\t\tself.emit('requestTimeout')\n\t\t\t}\n\t\t}\n\n\t\theadersList.forEach(function (header) {\n\t\t\txhr.setRequestHeader(header[0], header[1])\n\t\t})\n\n\t\tself._response = null\n\t\txhr.onreadystatechange = function () {\n\t\t\tswitch (xhr.readyState) {\n\t\t\t\tcase rStates.LOADING:\n\t\t\t\tcase rStates.DONE:\n\t\t\t\t\tself._onXHRProgress()\n\t\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t\t// Necessary for streaming in Firefox, since xhr.response is ONLY defined\n\t\t// in onprogress, not in onreadystatechange with xhr.readyState = 3\n\t\tif (self._mode === 'moz-chunked-arraybuffer') {\n\t\t\txhr.onprogress = function () {\n\t\t\t\tself._onXHRProgress()\n\t\t\t}\n\t\t}\n\n\t\txhr.onerror = function () {\n\t\t\tif (self._destroyed)\n\t\t\t\treturn\n\t\t\tself.emit('error', new Error('XHR error'))\n\t\t}\n\n\t\ttry {\n\t\t\txhr.send(body)\n\t\t} catch (err) {\n\t\t\tprocess.nextTick(function () {\n\t\t\t\tself.emit('error', err)\n\t\t\t})\n\t\t\treturn\n\t\t}\n\t}\n}\n\n/**\n * Checks if xhr.status is readable and non-zero, indicating no error.\n * Even though the spec says it should be available in readyState 3,\n * accessing it throws an exception in IE8\n */\nfunction statusValid (xhr) {\n\ttry {\n\t\tvar status = xhr.status\n\t\treturn (status !== null && status !== 0)\n\t} catch (e) {\n\t\treturn false\n\t}\n}\n\nClientRequest.prototype._onXHRProgress = function () {\n\tvar self = this\n\n\tif (!statusValid(self._xhr) || self._destroyed)\n\t\treturn\n\n\tif (!self._response)\n\t\tself._connect()\n\n\tself._response._onXHRProgress()\n}\n\nClientRequest.prototype._connect = function () {\n\tvar self = this\n\n\tif (self._destroyed)\n\t\treturn\n\n\tself._response = new IncomingMessage(self._xhr, self._fetchResponse, self._mode, self._fetchTimer)\n\tself._response.on('error', function(err) {\n\t\tself.emit('error', err)\n\t})\n\n\tself.emit('response', self._response)\n}\n\nClientRequest.prototype._write = function (chunk, encoding, cb) {\n\tvar self = this\n\n\tself._body.push(chunk)\n\tcb()\n}\n\nClientRequest.prototype.abort = ClientRequest.prototype.destroy = function () {\n\tvar self = this\n\tself._destroyed = true\n\tglobal.clearTimeout(self._fetchTimer)\n\tif (self._response)\n\t\tself._response._destroyed = true\n\tif (self._xhr)\n\t\tself._xhr.abort()\n\telse if (self._fetchAbortController)\n\t\tself._fetchAbortController.abort()\n}\n\nClientRequest.prototype.end = function (data, encoding, cb) {\n\tvar self = this\n\tif (typeof data === 'function') {\n\t\tcb = data\n\t\tdata = undefined\n\t}\n\n\tstream.Writable.prototype.end.call(self, data, encoding, cb)\n}\n\nClientRequest.prototype.flushHeaders = function () {}\nClientRequest.prototype.setTimeout = function () {}\nClientRequest.prototype.setNoDelay = function () {}\nClientRequest.prototype.setSocketKeepAlive = function () {}\n\n// Taken from http://www.w3.org/TR/XMLHttpRequest/#the-setrequestheader%28%29-method\nvar unsafeHeaders = [\n\t'accept-charset',\n\t'accept-encoding',\n\t'access-control-request-headers',\n\t'access-control-request-method',\n\t'connection',\n\t'content-length',\n\t'cookie',\n\t'cookie2',\n\t'date',\n\t'dnt',\n\t'expect',\n\t'host',\n\t'keep-alive',\n\t'origin',\n\t'referer',\n\t'te',\n\t'trailer',\n\t'transfer-encoding',\n\t'upgrade',\n\t'via'\n]\n"]},"metadata":{},"sourceType":"script"}